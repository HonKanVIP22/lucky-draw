<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Lucky Draw Pro</title>

<style>
body{
  background:url("nen.jpg") center/cover no-repeat fixed;
  font-family:'Segoe UI',Arial;
  color:#fff;
  text-align:center;
  margin:0;
  min-height:100vh;
}
.overlay{
  background:rgba(0,0,0,0.35);
  min-height:100vh;
  padding-top:50px;
}

/* ===== TITLE ===== */
h1{
  font-size:64px;
  font-weight:900;
  letter-spacing:4px;
  margin-bottom:28px;
  background:linear-gradient(90deg,#fff176,#ffeb3b,#ffc107);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.title-icon{
  display:inline-block;
  animation:rotateSlow 8s linear infinite;
  margin-right:14px;
}

/* ===== SLOT ===== */
.slot{
  display:flex;
  justify-content:center;
  gap:16px;
  margin:30px 0;
}
.digit{
  width:84px;
  height:118px;
  background:linear-gradient(180deg,#ffeb3b,#ffc107);
  color:#5d4037;
  font-size:66px;
  font-weight:900;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ===== SPIN BUTTON ===== */
#spinBtn{
  width:190px;
  height:190px;
  border-radius:50%;
  background:radial-gradient(circle,#ffeb3b,#ffc107);
  color:#5d4037;
  font-size:34px;
  font-weight:900;
  border:none;
  cursor:pointer;
}

/* ===== RIGHT PANEL ===== */
.right-panel{
  position:fixed;
  top:20px;
  right:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
  background:rgba(0,0,0,.4);
  padding:12px;
  border-radius:16px;
}
.right-panel select,
.right-panel input{
  width:150px;
  padding:8px;
  border-radius:12px;
  background:rgba(0,0,0,.5);
  color:#fff;
  border:none;
  text-align:center;
}
.right-panel button{
  padding:8px;
  border-radius:20px;
  border:none;
  cursor:pointer;
}
.export{background:#d50000;color:#fff}
.reset{background:#0d47a1;color:#fff}

/* ===== WINNER CENTER ===== */
#winnerBox{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  z-index:9999;
  align-items:center;
  justify-content:center;
}
#winnerContent{
  background:rgba(0,0,0,.85);
  padding:40px 60px;
  border-radius:30px;
  box-shadow:0 0 50px rgba(255,215,0,.9);
  position:relative;
}
#winnerContent h2{
  font-size:36px;
  color:#ffeb3b;
  margin-bottom:16px;
}
#winnerName{
  font-size:56px;
  font-weight:900;
}
#winnerCode{
  margin-top:12px;
  font-size:22px;
  opacity:.9;
}

/* ===== SPARKLE ===== */
.sparkle{
  position:absolute;
  font-size:26px;
  animation:sparkle 1.5s ease-in-out infinite;
}

/* ===== CONFETTI ===== */
.confetti{
  position:absolute;
  font-size:26px;
  animation:floatUp 2.8s linear infinite;
}

/* ===== RESULT ===== */
.result-box{
  margin:44px auto;
  width:88%;
  max-width:980px;
  background:rgba(0,0,0,0.5);
  border-radius:24px;
  padding:24px;
}
table{width:100%;border-collapse:collapse}
th,td{padding:14px}
.prize{color:#ffd54f;font-weight:800}
.code{font-family:monospace;font-size:20px}

/* ===== THAN TAI ===== */
.thantai-box{
  position:fixed;
  right:20px;
  bottom:40px;
  width:240px;
  z-index:998;
  text-align:center;
  animation:thantaiSwing 3s ease-in-out infinite;
}
.thantai-box img{
  width:100%;
  filter:drop-shadow(0 10px 25px rgba(0,0,0,.6));
}
.thantai-text{
  background:linear-gradient(90deg,#ffeb3b,#ffc107);
  color:#5d4037;
  font-weight:900;
  padding:8px 14px;
  border-radius:20px;
  margin-bottom:6px;
  display:inline-block;
  animation:textBounce 1.6s ease-in-out infinite;
  box-shadow:0 6px 18px rgba(0,0,0,.4);
}

  /* ===== HORSE STAND (NG·ª∞A ƒê·ª®NG) ===== */
.horse-stand{
  position:fixed;
  left:20px;
  bottom:40px;       /* B·∫∞NG bottom c·ªßa th·∫ßn t√†i */
  width:240px;       /* B·∫∞NG width c·ªßa th·∫ßn t√†i */
  z-index:998;
  text-align:center;
}
.horse-stand img{
  width:100%;
  filter:drop-shadow(0 10px 25px rgba(0,0,0,.6));
}
.horse-text{
  background:linear-gradient(90deg,#ffeb3b,#ffc107);
  color:#5d4037;
  font-weight:900;
  padding:8px 14px;
  border-radius:20px;
  margin-bottom:6px;
  display:inline-block;
  box-shadow:0 6px 18px rgba(0,0,0,.4);
}

/* ===== HORSE RUN ===== */
.horse-run{
  position:fixed;
  top:20px;
  left:-220px;
  width:300px;
  z-index:50;
  animation:horseRun 12s linear infinite;
  pointer-events:none;
}
.horse-run img{
  width:75%;
  filter:drop-shadow(0 10px 20px rgba(0,0,0,.6));
}
/* ==== GOM K·∫æT QU·∫¢ THEO ƒê·ª¢T ==== */
.round-header{
  cursor:pointer;
  background:rgba(255,215,0,.15);
  font-weight:900;
}
.round-header:hover{
  background:rgba(255,215,0,.3);
}
.round-detail{
  display:none;
}
/* ===== ANIMATIONS ===== */
@keyframes floatUp{
  from{transform:translateY(0) rotate(0);opacity:1}
  to{transform:translateY(-140px) rotate(360deg);opacity:0}
}
@keyframes sparkle{
  0%,100%{opacity:.2;transform:scale(.8)}
  50%{opacity:1;transform:scale(1.2)}
}
@keyframes rotateSlow{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}
@keyframes thantaiSwing{
  0%,100%{transform:rotate(-5deg)}
  50%{transform:rotate(5deg)}
}
@keyframes textBounce{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}
@keyframes horseRun{
  from{left:-220px;}
  to{left:110%;}
}
</style>
</head>

<body>

<div class="right-panel">
  <select id="prize">
    <option>Gi·∫£i Nh·∫•t</option>
    <option>Gi·∫£i Nh√¨</option>
    <option>Gi·∫£i Ba</option>
    <option>Gi·∫£i Th∆∞·ªüng</option>
  </select>
  <input id="drawCount" type="number" value="1" min="1">
  <button class="export" onclick="exportExcel()">üì• Xu·∫•t Excel</button>
  <button class="reset" onclick="resetAll()">üîÑ Reset</button>
</div>

<div id="winnerBox">
  <div id="winnerContent">
    <h2>üéâ CH√öC M·ª™NG üéâ</h2>
    <div class="sparkle" style="top:-10px;left:-20px;">‚ú®</div>
    <div class="sparkle" style="top:-10px;right:-20px;animation-delay:.5s">‚ú®</div>
    <div class="sparkle" style="bottom:-10px;left:45%;animation-delay:1s">‚≠ê</div>
    <div id="winnerName"></div>
    <div id="winnerCode"></div>
  </div>
</div>

<div id="confettiArea"></div>

<div class="overlay">

<h1><span class="title-icon">üéØ</span>QUAY S·ªê MAY M·∫ÆN</h1>

<div class="slot">
  <div class="digit">0</div><div class="digit">0</div>
  <div class="digit">0</div><div class="digit">0</div>
  <div class="digit">0</div>
</div>

<button id="spinBtn" onclick="draw()">QUAY</button>

<div class="result-box">
  <h2>üèÜ DANH S√ÅCH TR√öNG TH∆Ø·ªûNG</h2>
  <table>
    <thead>
      <tr><th>Gi·∫£i</th><th>M√£ s·ªë</th><th>H·ªç t√™n</th></tr>
    </thead>
    <tbody id="resultTable"></tbody>
  </table>
</div>

</div>

<!-- HORSE -->
<div class="horse-run">
  <img src="ngua.png" alt="Ng·ª±a ch·∫°y">
</div>
<!-- HORSE STAND -->
<div class="horse-stand">
  <div class="horse-text"> M√É ƒê√ÅO TH√ÄNH C√îNG </div>
  <img src="ngua2.png" alt="Ng·ª±a ƒë·ª©ng">
</div>
<!-- THAN TAI -->
<div class="thantai-box">
  <div class="thantai-text">‚ú® Ng∆∞·ªùi ·∫§y L√† Ai?? ‚ú®</div>
  <img src="thantai.png" alt="Th·∫ßn T√†i">
</div>

<script>
const defaultItems=[
 {code:"99991",name:"Nguy·ªÖn VƒÉn Kan"},
 {code:"00002",name:"Tr·∫ßn Th·ªã Ng√¢n"},
 {code:"00003",name:"L√™ VƒÉn C"},
 {code:"00004",name:"Ph·∫°m Th·ªã D"},
 {code:"00005",name:"Ho√†ng VƒÉn E"},
 {code:"00006",name:"Ho√†ng VƒÉn kon"},
];

let items=JSON.parse(localStorage.getItem("ITEMS"))||[...defaultItems];
let results=JSON.parse(localStorage.getItem("RESULTS"))||[];
let round=parseInt(localStorage.getItem("ROUND"))||1;
window.onload=renderTable;

function spinDigits(target){
  let d=document.querySelectorAll(".digit");
  let i=0;
  let it=setInterval(()=>{
    d.forEach(x=>x.innerText=Math.floor(Math.random()*10));
    if(++i>40){
      clearInterval(it);
      target.code.split("").forEach((n,j)=>d[j].innerText=n);
    }
  },120);
}

function draw(){
  let count=parseInt(drawCount.value)||1;
  if(count>items.length){alert("Kh√¥ng ƒë·ªß ng∆∞·ªùi");return;}
  let prizeValue=prize.value;
  let delay=0;
  let currentRound=round;

  for(let k=0;k<count;k++){
    setTimeout(()=>{
      let i=Math.floor(Math.random()*items.length);
      let item=items.splice(i,1)[0];
      spinDigits(item);
      setTimeout(()=>showWinner(item,prizeValue,currentRound),5000);
    },delay);
    delay+=4500;
  }

  round++;
  localStorage.setItem("ROUND",round);
}

function showWinner(item,prizeValue,roundNo){
  winnerName.innerText=item.name;
  winnerCode.innerText="M√£ s·ªë: "+item.code;
  winnerBox.style.display="flex";

  setTimeout(()=>{
    winnerBox.style.display="none";
    results.push({
      prize: prizeValue,
      round: roundNo,   // üëà th√™m round
      ...item
    });
    localStorage.setItem("ITEMS",JSON.stringify(items));
    localStorage.setItem("RESULTS",JSON.stringify(results));
    renderTable();
  },4000);
}


function renderTable(){
  resultTable.innerHTML="";
  let grouped={};

  results.forEach(r=>{
    let key=`${r.prize} - ƒê·ª£t ${r.round}`;
    if(!grouped[key]) grouped[key]=[];
    grouped[key].push(r);
  });

  Object.keys(grouped).forEach(key=>{
    let cls="r"+Math.random().toString(36).substr(2,6);

    resultTable.innerHTML+=`
      <tr class="round-header" onclick="toggle('${cls}')">
        <td colspan="3">‚ñ∂ ${key} (${grouped[key].length} ng∆∞·ªùi)</td>
      </tr>
    `;

    grouped[key].forEach(r=>{
      resultTable.innerHTML+=`
        <tr class="round-detail ${cls}">
          <td>${r.prize}</td>
          <td class="code">${r.code}</td>
          <td>${r.name}</td>
        </tr>
      `;
    });
  });
}
function toggle(cls){
  document.querySelectorAll("."+cls).forEach(r=>{
    r.style.display = r.style.display==="table-row" ? "none":"table-row";
  });
}
function exportCSV(){
  let csv="Prize,Code,Name\n";
  results.forEach(r=>csv+=`${r.prize},${r.code},${r.name}\n`);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="ketqua_quayso.csv";
  a.click();
}
function exportExcel(){
  if(results.length===0){
    alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t");
    return;
  }

  let data = results.map(r => ({
    "Gi·∫£i": r.prize,
    "ƒê·ª£t": r.round,
    "M√£ s·ªë": r.code,
    "H·ªç t√™n": r.name
  }));

  let ws = XLSX.utils.json_to_sheet(data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "K·∫øt qu·∫£");

  XLSX.writeFile(wb, "ketqua_quayso.xlsx");
}

function resetAll(){
  if(!confirm("RESET to√†n b·ªô d·ªØ li·ªáu?")) return;

  localStorage.clear();

  items = [...defaultItems];
  results = [];
  round = 1; // ‚≠ê RESET S·ªê ƒê·ª¢T

  localStorage.setItem("ROUND", round);

  renderTable();
  document.querySelectorAll(".digit").forEach(d=>d.innerText="0");
}


/* THAN TAI + NG·ª∞A CH·∫†Y NHANH KHI QUAY */
const spinBtnEl=document.getElementById("spinBtn");
const thanTai=document.querySelector(".thantai-box");
const horse=document.querySelector(".horse-run");

spinBtnEl.addEventListener("click",()=>{
  thanTai.style.animation="thantaiSwing .6s ease-in-out infinite";
  horse.style.animation="horseRun 6s linear infinite";
  setTimeout(()=>{
    thanTai.style.animation="thantaiSwing 3s ease-in-out infinite";
    horse.style.animation="horseRun 12s linear infinite";
  },3000);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
